<!DOCTYPE html>
<html lang="fr">
<head>
<style>
html, body {
	height:100%;
	width:100%;
	margin:0;
	padding:0;
}
.text {
	width:90%;
	height:90%;
}
</style>
<meta charset="utf-8" />
<title>Test TW schedule</title>
</head>
<body>
Day index start: <input type="number" id="minDay" value="0"></input><br/>
<label for="minDay">Day index start</label>
Day index end: <input type="number" id="maxDay" value="7"></input><br/>
<label for="maxDay">Day index end</label>
Droid officer <input type="checkbox" id="droid" checked="true"></input>
<label for="droid">Droid officer</label>
Ruin manager <input type="checkbox" id="ruin" checked="true"></input>
<label for="ruin">Ruin manager</label>
WB 1<input type="checkbox" id="wb1" checked="true"></input>
<label for="wb1"WB 1</label>
WB 2<input type="checkbox" id="wb2" checked="true"></input>
<label for="wb2">WB 2</label>
WB 3<input type="checkbox" id="wb3" checked="true"></input>
<label for="wb3">WB 3</label>
<!--<button id="run">Click here to generate</button>-->
<br/>
<label>Result code</label>
<br/>
<textarea class="text" id="output"></textarea>
<script>
"use strict";
const update = ()=>{
	const HOURS_MS = 60*60*1000, DAY_MS = 24*HOURS_MS;
	
	// Number between 0 and 4 in case cycle drifts due to complications
	const RSS_OFFSET = 1;
	// When server time reaches 00h00
	const UTC_OFFSET = 8*HOURS_MS;

	const pad = (obj, length)=>{ return (""+obj).padStart(length,'0'); }

	// 8h UTC is when my server's time in settings reach 00h00
	let lastReset = new Date().getTime();

	// Offset between YOUR time, and the last reset time in server's timezone
	let TIME_OFFSET = lastReset%DAY_MS + UTC_OFFSET;
	if (TIME_OFFSET >= DAY_MS) TIME_OFFSET -= DAY_MS;
	// lastReset now refers to the last encountered reset time in UTC
	lastReset = lastReset - TIME_OFFSET;
	console.log("Server reset time in your timezone: "+new Date(lastReset));

	let currentTime;
	const UTCreset = (minutes)=>{
		return new Date(currentTime+ minutes*60*1000);
	};
	
	const result = new Map();
	const addTask = (hours, reason)=>{
		let visual = "Reset+"+hours;
		if (hours > 12) visual = "Reset-"+(24-hours); 
		result.set(UTCreset(hours*60), visual+" for "+reason);
	};
	
	// Current day + 7 in the future
	for (let day = 0; day<8; day++) {
		currentTime = lastReset+ DAY_MS*day;
		let currentDay = new Date(currentTime+UTC_OFFSET).getUTCDay();
		// Treat Sunday as end of week
		if (currentDay < 1) currentDay += 7;

		// Establish an index based on number of days. Allows to establish self-referencing cycles
		const diff = Math.floor(currentTime/DAY_MS);

		// Resources on a cycle
		// Oil+Food, Oil, Food+Oil, Food
		const rssIndex = (diff+RSS_OFFSET)%4;
		addTask(2, "1st rss : "+ (rssIndex<2?"Oil":"Food"));
		if (rssIndex%2 === 0)
			addTask(23, "2nd rss : " + (rssIndex===2?"Oil":"Food"));

		const droidTime = 3;
		addTask(droidTime, "Droid summon (requires officer)");
		addTask(droidTime+12, "Droid setup (requires officer) : ??? (alpha-5?)");
		
		// 3 WB cycles
		for (let time = 4; time < 24; time +=8) {
			let t = time;
			const end = t+1;
			let reason = "WB";
			
			if (currentDay>=5) {
				reason = "LQ";
				t-=1;
			}

			addTask(t,reason+" damage flag");
			addTask(end,"gathering flag");
		}
	}
	
	let txt = "Here's the schedule!";
	for (var [date,name] of new Map([...result.entries()].sort(function(a,b){return a[0]-b[0];}))) {
		txt += "\n\n"+pad(date.getFullYear(),4)+"-"+pad(date.getMonth()+1,2)+"-"+pad(date.getDate(),2)+" "+pad(date.getHours(),2)+":"+pad(date.getMinutes(),2)+"\n"+name;
	}
	document.getElementById('output').value = txt;
};
for (let item of document.getElementsByTagName("input"))
	item.addEventListener('change',update);
update();
</script>
</body>
</html>
