<!DOCTYPE html>
<html lang="fr">
<head>
<style>
html, body {
	height:100%;
	width:100%;
	margin:0;
	padding:0;
}
.text {
	width:90%;
	height:90%;
}
</style>
<meta charset="utf-8" />
<title>Test TW schedule</title>
</head>
<body>
<!--
<input type="number" id="minYear" value="2017"></input>
<input type="number" id="maxYear" value="2030"></input>
<button id="run">Click here to generate</button>
-->
<br/>
<label>Result code</label>
<br/>
<textarea class="text" id="output"></textarea>
<script>
"use strict";
/*document.getElementById('run').addEventListener('click', */(function(){
	const HOURS_MS = 60*60*1000, DAY_MS = 24*HOURS_MS;
	
	// Number between 0 and 4 in case cycle drifts due to complications
	const RSS_OFFSET = 3;
	// When server time reaches 00h00
	const UTC_OFFSET = 16*HOURS_MS;

	// Source : https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Remainder
	const mod = (n, d)=>{ return ((n % d) + d) % d; }
	const pad = (obj, length)=>{ return (""+obj).padStart('0',length); }

	// 8h UTC is when my server's time in settings reach 00h00
	let lastReset = new Date().getTime();

	// Offset between your UTC time and reset time
	let TIME_OFFSET = lastReset%DAY_MS - 16*HOURS_MS;
	if (TIME_OFFSET < 0) TIME_OFFSET += DAY_MS;
	
	lastReset = lastReset - TIME_OFFSET;
	
	const result = new Map();

	let currentTime;
	const UTCreset = (minutes)=>{
		return new Date(currentTime+ minutes*60*1000);
	};
	
	// Current day + 7 in the future
	for (let day = 0; day<8; day++) {
		currentTime = lastReset+ DAY_MS*day;
		let currentDay = new Date(currentTime).getUTCDay();
		// Treat Sunday as end of week
		//if (currentDay < 1) currentDay += 7;

		// Establish an index based on number of days. Allows to establish self-referencing cycles
		const diff = Math.floor(currentTime/DAY_MS);

		// Resources on a cycle
		// Oil+Food, Oil, Food+Oil, Food
		const rssIndex = mod(diff+RSS_OFFSET,4), doubleDip = mod(rssIndex,2);
		console.log(rssIndex);
		console.log(doubleDip);
		result.set(UTCreset(2*60), "Reset+2 for 1st rss : "+ (rssIndex<2?"Oil":"Food"));
		if (doubleDip === 0) {
			result.set(UTCreset(-1*60), "Reset-1 from 2nd rss : " + (rssIndex===2?"Oil":"Food"));
		}
		
		// 3 WB cycles
		for (let time = 4; time < 24; time +=8) {
			let t = time;
			const end = t+1;
			let reason = "WB";
			
			if (currentDay>=4) {
				reason = "LQ";
				t-=1;
			}
			
			result.set(UTCreset(t*60), "Reset+"+t+" for "+reason+" damage flag");
			result.set(UTCreset(end*60), "Reset+"+end+" for gathering flag");
		}
	}
	
	let txt = "Debug example";
	for (var [date,name] of new Map([...result.entries()].sort(function(a,b){return a[0]-b[0];}))) {
		txt += "\n\n"+pad(date.getFullYear(),4)+"-"+pad(date.getMonth()+1,2)+"-"+pad(date.getDate(),2)+" "+pad(date.getHours(),2)+":"+pad(date.getMinutes(),2)+"\n"+name;
	}
	document.getElementById('output').value = txt;
}/*);*/)();
</script>
</body>
</html>
