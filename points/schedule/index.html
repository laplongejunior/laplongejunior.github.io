<!DOCTYPE html>
<html lang="fr">
<head>
<style>
html, body {
	height:100%;
	width:100%;
	margin:0;
	padding:0;
}
.text {
	width:90%;
	height:90%;
}
</style>
<meta charset="utf-8" />
<title>Test TW schedule</title>
</head>
<body>
<!--
<input type="number" id="minYear" value="2017"></input>
<input type="number" id="maxYear" value="2030"></input>
<button id="run">Click here to generate</button>
-->
<br/>
<label>Result code</label>
<br/>
<textarea class="text" id="output"></textarea>
<script>
"use strict";
/*document.getElementById('run').addEventListener('click', */(function(){
	const HOURS_MS = 60*60*1000, DAY_MS = 24*HOURS_MS;
	
	// Number between 0 and 4 in case cycle drifts due to complications
	const RSS_OFFSET = 1;
	// When server time reaches 00h00
	const UTC_OFFSET = 16*HOURS_MS;

	// Source : https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Remainder
	const mod = (n, d)=>{ return ((n % d) + d) % d; }

	// 8h UTC is when my server's time in settings reach 00h00
	let lastReset = new Date().getTime();

	// Offset between your UTC time and reset time
	console.log(lastReset%DAY_MS);
	let TIME_OFFSET = lastReset%DAY_MS - 16*HOURS_MS;
	console.log(TIME_OFFSET);
	if (TIME_OFFSET < 0) TIME_OFFSET += DAY_MS;
	console.log(TIME_OFFSET);
	
	lastReset = lastReset - TIME_OFFSET;
	
	const today = new Date(lastReset);
	console.log(today);
	
	const result = new Map();

	let currentTime;
	const UTCreset = (minutes)=>{
		return new Date(currentTime+ minutes*60*1000);
	};
	
	// Current day + 7 in the future
	for (let day = 0; day<8; day++) {
		currentTime = lastReset+ DAY_MS*day;
		const currentDay = new Date(currentTime).getUTCDay();
		// Treat Sunday as end of week
		if (currentDay === 0) currentDay = 7;

		// Establish an index based on number of days. Allows to establish self-sutenting cycles
		const diff = currentTime / DAY_MS;
	
		for (const time = 4; time < 24; time +=8) {
			let t = time;
			const end = t+1;
			let reason = "WB";
			
			if (currentDay>=5) {
				reason = "LQ";
				time-=1;
			}
			
			result.set(UTCreset(t*60), "Reset+"+t+" for "+reason+" damage flag");
			result.set(UTCreset(end*60), "Reset+"+end+" for gathering flag");
		}
		
	
		const rssIndex = mod(diff+RSS_OFFSET,4), doubleDip = mod(rssIndex,2);
		console.log(doubleDip);
		result.set(UTCreset(2*60), "Reset+2 for 1st rss : "+ (rssIndex<2?"Food":"Oil"));
		if (doubleDip === 0) {
			result.set(UTCreset(-1*60), "2nd rss : " + (rssIndex===2?"Food":"Oil"));
		}
		// Food+Oil
		// Food
		// Oil+Food
		// Oil
	}
	
	let txt = "Debug example";
	for (var [date,name] of new Map([...result.entries()].sort(function(a,b){return a[0]-b[0];})))
		txt += "\n\n"+date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+"-"+date.getMinutes()+"\n"+name;
	document.getElementById('output').value = txt;
}/*);*/)();
</script>
</body>
</html>
