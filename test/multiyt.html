<!DOCTYPE html>
<html lang="fr">
<head>
	<title>Titre</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="referrer" content="never" />
	<meta name="referrer" content="no-referrer" />
</head>
<body>
	<span class="ytContainer">
	</span>
<script>
	"strict mode";
	const AUTO_PLAY = true;	
	const playerID = "ytContainer";
	
	var schedule = new Array();
	schedule.push(['fLeY_UF1puE',0,4]);
	schedule.push(['jmHK4vIvWLE',10,15]);
	// TODO: Put this in first place
	schedule.push(['jmHK4vIvWLE',60,75]);

	// Global object name reserved by YT api
	window.onYouTubeIframeAPIReady = function() {
		window.onYouTubeIframeAPIReady = undefined;
		for (var container of document.getElementsByClassName(playerID))
			MultiPlayer(container,schedule);
	}
		
	_async('script','src',"https://www.youtube.com/iframe_api");
	function _async() {
		var tagName = arguments[0];
		var tag = document.createElement(tagName);
		var length = arguments.length;
		for (var i = 1; i+1 < length; i+=2)
			tag[arguments[i]] = arguments[i+1];
		var first = document.getElementsByTagName(tagName)[0];
		first.parentNode.insertBefore(tag, first);
		return tag;
	}
	
	const PlayerState = {
		NOT_STARTED:-1,
		STOPPED:0,
		RUNNING:1,
		PAUSED:2,
		BUFFERING:3,
		WAITING:5
	};
	
	const MultiPlayer = function(container, schedule) {
		// Only optimized for two players
		const PLAYER_CACHE = 2;
		var players = new Array();
		
		var ready = 0;
		const readyCheck = ()=>{
			if (++ready === PLAYER_CACHE) initMulti();
		};
		
		const PREFIX = "ytPlayer";
		for (var i=0; i<PLAYER_CACHE; ++i) {
			const id = PREFIX+i;
			
			var mask = document.createElement("span");
			container.appendChild(mask);
			mask.style.display = 'none';
			
			var player = document.createElement("div");
			player.id = id;
			mask.appendChild(player);
			
			const YTplayer = new YT.Player(id, {events: {
				'onReady': e=>{				
					readyCheck();
					const element = e.target.getIframe();
					element.style.display = (element.id === "ytPlayer"+0) ? 'initial':'none';
					// Moving the video breaks loading
					//document.getElementById(playerID).replaceChild(element,element.parentNode);
					element.parentNode.style.display = 'initial';
				},
				
				// The YT override addEventListener in such a way the event is overwritten each time
				// To avoid that, we'll store the listeners in the player and call them with the unique event
				'onStateChange': e=>{
					var listeners = e.target._listeners.get('onStateChange');
					if (listeners) listeners.forEach(func=>func(e));
				}
			}});

			// List of listeners for onStateChange
			YTplayer._listeners = new Map();
			YTplayer.addEventListener = (name, callback) => {
				var listeners = YTplayer._listeners.get(name);
				if (!listeners) YTplayer._listeners.set(name, listeners = new Array());
				listeners.push(callback);
			};
			YTplayer.removeEventListener = (name, callback) => {
				var listeners = YTplayer._listeners.get(name);
				if (listeners)
					listeners.splice(listeners.indexOf(callback),1);
			};
			
			players.push(YTplayer);
		}
	
		var nextID = 0;
		const initMulti = function() {
			var params = schedule.shift();
			const player = players[nextID];
			_singleCallEvent(player,"onStateChange",()=>loadNext(false));				
			loadSegment(player, params[0], params[1], params[2], AUTO_PLAY);
		}
		
		var last = false;
		const loadNext = function(play) {
			if (last) return;
			
			var params = schedule.shift();		
			if (!params) last = true;
			if (play) playSegment(players[nextID], !last, true);
			if (last) return;
			
			nextID++;
			if (nextID === PLAYER_CACHE) nextID = 0;
			var player = players[nextID];
			loadSegment(player, params[0], params[1], params[2], false);
		}
		
		const loadSegment = function(player, id, start, end, play) {
			_loadSegment(player, id, start, end, play, ()=>loadNext(true));
		}
		
		const playSegment = function(player, next, autoPlay) {
			_playSegment(player, autoPlay, next ? ()=>loadNext(true) : null);
		}
	}
	
	const _loadSegment = function(player, id, start, end, play, callback) {
		_singleCallEvent(player, "onStateChange", e=>{
			_playSegment(player, play, callback);
		});
		
		player.cueVideoById({
			'videoId': id,
			'startSeconds': start,
			'endSeconds': end,
			'suggestedQuality': 'large'});
	}
	const _playSegment = function(player, autoPlay, callback) {
		player.playVideo();	
		// Trigger buffering
		if (!autoPlay) {
			_singleCallEvent(player,"onStateChange",()=>{
				player.pauseVideo();
			});	
			return;
		}
		
		player.getIframe().style.display = 'initial';
		if (!callback) return;
		
		_singleCallEvent(player, "onStateChange", e=>{
			if (e.data !== PlayerState.STOPPED) return true;
			callback(e);
			e.target.getIframe().style.display = 'none';
		});
	}
	
	function _singleCallEvent(object, name, func) {
		const CALL = event=>{
			if (func(event)) return;
			object.removeEventListener(name, CALL);
		};
		object.addEventListener(name, CALL);
	}
</script>
</body>
</html>
